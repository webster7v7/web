<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¯¼èˆªç«™é…ç½®å·¥å…·</title>
  <style>
    /* å¯æ”¹å‚æ•°ï¼šä¸»é¢˜é¢œè‰²é…ç½® */
    :root {
      --bg-color: #1a1a1a;
      --card-bg: #2d2d2d;
      --input-bg: #3a3a3a;
      --text-primary: #e5e5e5;
      --text-secondary: #a0a0a0;
      --border-color: #444;
      --primary-color: #3b82f6;
      --primary-hover: #2563eb;
      --danger-color: #ef4444;
      --danger-hover: #dc2626;
      --success-color: #10b981;
      --warning-color: #f59e0b;
      --shadow: rgba(0, 0, 0, 0.3);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background-color: var(--bg-color);
      color: var(--text-primary);
      line-height: 1.6;
      padding: 20px;
      min-height: 100vh;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
    }

    header {
      background-color: var(--card-bg);
      padding: 24px;
      border-radius: 12px;
      margin-bottom: 24px;
      box-shadow: 0 4px 12px var(--shadow);
    }

    h1 {
      font-size: 1.875rem;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 16px;
      flex-wrap: wrap;
    }

    #file-status {
      color: var(--text-secondary);
      font-size: 0.875rem;
      flex: 1;
    }

    #file-status.active {
      color: var(--success-color);
      font-weight: 500;
    }

    /* å¯æ”¹å‚æ•°ï¼šæŒ‰é’®æ ·å¼å’Œå°ºå¯¸ */
    button {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 500;
    }

    .btn-primary {
      background-color: var(--primary-color);
      color: white;
    }

    .btn-primary:hover {
      background-color: var(--primary-hover);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .btn-danger {
      background-color: transparent;
      color: var(--danger-color);
      font-size: 1.5rem;
      padding: 4px 12px;
      min-width: 36px;
      transition: all 0.2s;
    }

    .btn-danger:hover {
      background-color: var(--danger-color);
      color: white;
      transform: scale(1.1);
    }

    /* å¯æ”¹å‚æ•°ï¼šè‡ªåŠ¨è·å–æŒ‰é’®å’Œè¾“å…¥æ¡†ç»„åˆæ ·å¼ */
    .input-with-button {
      display: flex;
      gap: 8px;
    }

    .input-with-button input {
      flex: 1;
    }

    .btn-secondary {
      background-color: var(--input-bg);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      padding: 12px 16px;
      white-space: nowrap;
      min-width: 120px;
    }

    .btn-secondary:hover {
      background-color: #444;
      border-color: var(--primary-color);
    }

    .btn-secondary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-secondary.loading {
      position: relative;
      color: transparent;
    }

    .btn-secondary.loading::after {
      content: '';
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      width: 16px;
      height: 16px;
      border: 2px solid var(--primary-color);
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
    }

    @keyframes spin {
      to { transform: translate(-50%, -50%) rotate(360deg); }
    }

    /* å¯æ”¹å‚æ•°ï¼šè‡ªåŠ¨è·å–é¢„è§ˆåŒºåŸŸæ ·å¼ */
    .fetch-preview {
      margin-top: 16px;
      padding: 16px;
      background-color: var(--input-bg);
      border-radius: 8px;
      display: flex;
      gap: 16px;
      align-items: center;
      border: 1px solid var(--border-color);
    }

    .preview-icon {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .preview-icon img {
      width: 48px;
      height: 48px;
      border-radius: 8px;
      object-fit: cover;
    }

    .preview-color-box {
      width: 48px;
      height: 48px;
      border-radius: 8px;
      border: 1px solid var(--border-color);
    }

    .preview-info {
      flex: 1;
      font-size: 0.875rem;
      color: var(--text-secondary);
    }

    .warning {
      background-color: rgba(245, 158, 11, 0.1);
      border-left: 4px solid var(--warning-color);
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 24px;
      display: none;
    }

    .info-box {
      background-color: rgba(59, 130, 246, 0.1);
      border-left: 4px solid var(--primary-color);
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 24px;
      font-size: 0.875rem;
      line-height: 1.8;
    }

    .info-box h3 {
      font-size: 1rem;
      margin-bottom: 8px;
      color: var(--primary-color);
    }

    .info-box ol {
      margin-left: 20px;
    }

    section {
      background-color: var(--card-bg);
      padding: 24px;
      border-radius: 12px;
      margin-bottom: 24px;
      box-shadow: 0 4px 12px var(--shadow);
    }

    section h2 {
      font-size: 1.25rem;
      margin-bottom: 20px;
      color: var(--text-primary);
    }

    .form-group {
      margin-bottom: 16px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: var(--text-primary);
    }

    input {
      width: 100%;
      padding: 12px;
      background-color: var(--input-bg);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 1rem;
      transition: border-color 0.3s;
    }

    input:focus {
      outline: none;
      border-color: var(--primary-color);
    }

    input::placeholder {
      color: var(--text-secondary);
    }

    #add-btn {
      width: 100%;
      padding: 14px;
      font-size: 1.125rem;
    }

    /* å¯æ”¹å‚æ•°ï¼šå¡ç‰‡åˆ—è¡¨é¡¹æ ·å¼ */
    #cards {
      list-style: none;
    }

    .card-item {
      background-color: var(--input-bg);
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 16px;
      transition: all 0.3s;
      border: 1px solid transparent;
    }

    .card-item:hover {
      background-color: #444;
      border-color: var(--primary-color);
      transform: translateX(4px);
    }

    .card-info {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .card-info strong {
      font-size: 1.125rem;
      color: var(--text-primary);
    }

    .card-info .url {
      font-size: 0.875rem;
      color: var(--primary-color);
      word-break: break-all;
    }

    .card-info .desc {
      font-size: 0.875rem;
      color: var(--text-secondary);
    }

    .empty {
      text-align: center;
      color: var(--text-secondary);
      padding: 40px;
      font-style: italic;
    }

    /* æ¶ˆæ¯æç¤ºæ ·å¼ */
    .message {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 16px 24px;
      border-radius: 8px;
      color: white;
      font-weight: 500;
      box-shadow: 0 4px 12px var(--shadow);
      animation: slideIn 0.3s ease-out;
      z-index: 1000;
    }

    .message.success {
      background-color: var(--success-color);
    }

    .message.error {
      background-color: var(--danger-color);
    }

    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 768px) {
      body {
        padding: 12px;
      }

      header, section {
        padding: 16px;
      }

      h1 {
        font-size: 1.5rem;
      }

      .header-actions {
        flex-direction: column;
        align-items: stretch;
      }

      .card-item {
        flex-direction: column;
        align-items: flex-start;
      }

      .btn-danger {
        align-self: flex-end;
      }

      .message {
        left: 20px;
        right: 20px;
      }

      .input-with-button {
        flex-direction: column;
      }

      .btn-secondary {
        width: 100%;
      }

      .fetch-preview {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 12px;">
        <h1 style="margin: 0;">ğŸ› ï¸ å¯¼èˆªç«™é…ç½®å·¥å…·</h1>
        <a href="index.html" class="btn-secondary" style="text-decoration: none; display: inline-flex; align-items: center; gap: 8px;">
          â† è¿”å›å¯¼èˆªç«™
        </a>
      </div>
      <div class="header-actions">
        <button id="select-file" class="btn-primary">ğŸ“ é€‰æ‹© index.html</button>
        <span id="file-status">æœªé€‰æ‹©æ–‡ä»¶</span>
      </div>
    </header>

    <div id="browser-warning" class="warning">
      âš ï¸ æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒæ–‡ä»¶ç³»ç»Ÿè®¿é—®åŠŸèƒ½ã€‚è¯·ä½¿ç”¨ Chrome 86+ã€Edge 86+ æˆ–å…¶ä»–åŸºäº Chromium çš„æµè§ˆå™¨ã€‚
    </div>

    <div class="info-box">
      <h3>ğŸ“– ä½¿ç”¨è¯´æ˜</h3>
      <ol>
        <li>å¿…é¡»ä½¿ç”¨ Chrome 86+ã€Edge 86+ æˆ–åŸºäº Chromium çš„æµè§ˆå™¨</li>
        <li>ç‚¹å‡»"é€‰æ‹© index.html"å¹¶æˆæƒæ–‡ä»¶è®¿é—®</li>
        <li>æ¯æ¬¡æ·»åŠ /åˆ é™¤ä¼šç«‹å³ä¿å­˜åˆ°ç¡¬ç›˜</li>
        <li>å»ºè®®å…ˆå¤‡ä»½ index.html æ–‡ä»¶</li>
      </ol>
    </div>

    <section id="add-form">
      <h2>â• æ·»åŠ æ–°å¡ç‰‡</h2>
      <div class="form-group">
        <label for="name">ç½‘ç«™åç§° *</label>
        <input type="text" id="name" placeholder="ä¾‹å¦‚ï¼šGoogle" required>
      </div>
      <div class="form-group">
        <label for="url">ç½‘å€ *</label>
        <div class="input-with-button">
          <input type="text" id="url" placeholder="ä¾‹å¦‚ï¼šhttps://www.google.com" required>
          <button type="button" id="auto-fetch-btn" class="btn-secondary">ğŸ” è‡ªåŠ¨è·å–</button>
        </div>
      </div>
      <div id="fetch-preview" class="fetch-preview" style="display: none;">
        <div class="preview-icon">
          <img id="preview-icon-img" src="" alt="å›¾æ ‡é¢„è§ˆ">
          <div id="preview-color" class="preview-color-box"></div>
        </div>
        <div class="preview-info">
          <span id="preview-theme-color">ä¸»é¢˜è‰²ï¼šæœªè·å–</span>
        </div>
      </div>
      <div class="form-group">
        <label for="description">æè¿°</label>
        <input type="text" id="description" placeholder="ä¾‹å¦‚ï¼šå…¨çƒæœ€å¤§çš„æœç´¢å¼•æ“">
      </div>
      <button id="add-btn" class="btn-primary">âœ¨ æ·»åŠ å¡ç‰‡</button>
    </section>

    <section id="card-list-section">
      <h2>ğŸ“‹ å·²æœ‰å¡ç‰‡</h2>
      <ul id="cards">
        <li class="empty">è¯·å…ˆé€‰æ‹© index.html æ–‡ä»¶</li>
      </ul>
    </section>
  </div>

  <script>
    // å…¨å±€å˜é‡ï¼šå¯æ”¹å‚æ•°ï¼ˆæ–‡ä»¶å¥æŸ„å’Œé…ç½®æ•°æ®ï¼‰
    let fileHandle = null;           // æ–‡ä»¶å¥æŸ„
    let configArray = [];            // é…ç½®æ•°ç»„
    let originalContent = '';        // åŸå§‹æ–‡ä»¶å†…å®¹
    let fetchedIconUrl = '';         // è‡ªåŠ¨è·å–çš„å›¾æ ‡ URL
    let fetchedThemeColor = '';      // è‡ªåŠ¨è·å–çš„ä¸»é¢˜è‰²

    // æ£€æŸ¥æµè§ˆå™¨æ”¯æŒ
    function checkBrowserSupport() {
      const warning = document.getElementById('browser-warning');
      if (!('showOpenFilePicker' in window)) {
        warning.style.display = 'block';
        document.getElementById('select-file').disabled = true;
      }
    }

    // ç”Ÿæˆå”¯ä¸€ ID
    function generateId() {
      return `site_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    }

    // æå–åŸŸåå¹¶ç”Ÿæˆ favicon URL
    function extractDomain(url) {
      // ç¡®ä¿ URL åŒ…å«åè®®
      if (!/^https?:\/\//i.test(url)) {
        url = 'https://' + url;
      }
      try {
        const urlObj = new URL(url);
        return urlObj.origin;
      } catch (e) {
        return url;
      }
    }

    // URL æ ¼å¼éªŒè¯
    function isValidUrl(string) {
      // è¡¥å…¨åè®®
      if (!/^https?:\/\//i.test(string)) {
        string = 'https://' + string;
      }
      try {
        new URL(string);
        return true;
      } catch (_) {
        return false;
      }
    }

    // å¯æ”¹å‚æ•°ï¼šé€šè¿‡ CORS ä»£ç†æŠ“å–é¡µé¢å†…å®¹
    async function fetchPageContent(url) {
      // ç¡®ä¿ URL æ ¼å¼æ­£ç¡®
      if (!/^https?:\/\//i.test(url)) {
        url = 'https://' + url;
      }

      // ä½¿ç”¨ CORS ä»£ç†
      const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(url)}`;

      try {
        const response = await fetch(proxyUrl, {
          method: 'GET',
          headers: {
            'Accept': 'text/html'
          }
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }

        const html = await response.text();
        return html;
      } catch (error) {
        throw new Error('æ— æ³•è®¿é—®ç›®æ ‡ç½‘ç«™');
      }
    }

    // ä» HTML å†…å®¹ä¸­æå–é¡µé¢ä¿¡æ¯
    function extractPageInfo(html, baseUrl) {
      // åˆ›å»ºä¸´æ—¶ DOM è§£æå™¨
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');

      // æå–æ ‡é¢˜
      let title = doc.querySelector('title')?.textContent?.trim() || '';
      // æ¸…ç†æ ‡é¢˜ï¼ˆç§»é™¤å¤šä½™ç©ºç™½ï¼‰
      title = title.replace(/\s+/g, ' ');

      // æå–å›¾æ ‡
      let iconUrl = '';

      // ä¼˜å…ˆçº§1: link rel="icon"
      const iconLink = doc.querySelector('link[rel*="icon"]');
      if (iconLink) {
        iconUrl = iconLink.getAttribute('href');
      }

      // ä¼˜å…ˆçº§2: link rel="shortcut icon"
      if (!iconUrl) {
        const shortcutIcon = doc.querySelector('link[rel="shortcut icon"]');
        if (shortcutIcon) {
          iconUrl = shortcutIcon.getAttribute('href');
        }
      }

      // å¤„ç†ç›¸å¯¹è·¯å¾„
      if (iconUrl) {
        try {
          iconUrl = new URL(iconUrl, baseUrl).href;
        } catch (e) {
          iconUrl = '';
        }
      }

      // é™çº§æ–¹æ¡ˆï¼šä½¿ç”¨é»˜è®¤ favicon è·¯å¾„
      if (!iconUrl) {
        try {
          const urlObj = new URL(baseUrl);
          iconUrl = `${urlObj.origin}/favicon.ico`;
        } catch (e) {
          iconUrl = '';
        }
      }

      return {
        title,
        iconUrl
      };
    }

    // ä»å›¾æ ‡æå–ä¸»é¢˜è‰²
    async function extractThemeColor(imageUrl) {
      return new Promise((resolve, reject) => {
        // é€šè¿‡ä»£ç†åŠ è½½å›¾æ ‡ï¼ˆé¿å…è·¨åŸŸï¼‰
        const proxyImageUrl = `https://corsproxy.io/?${encodeURIComponent(imageUrl)}`;

        const img = new Image();
        img.crossOrigin = 'Anonymous';

        img.onload = function() {
          try {
            // åˆ›å»º Canvas
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');

            canvas.width = img.width;
            canvas.height = img.height;

            // ç»˜åˆ¶å›¾åƒ
            ctx.drawImage(img, 0, 0);

            // è·å–å›¾åƒæ•°æ®
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const pixels = imageData.data;

            // è®¡ç®—å¹³å‡é¢œè‰²ï¼ˆå¿½ç•¥é€æ˜åƒç´ ï¼‰
            let r = 0, g = 0, b = 0, count = 0;

            for (let i = 0; i < pixels.length; i += 4) {
              const alpha = pixels[i + 3];

              // åªè®¡ç®—ä¸é€æ˜çš„åƒç´ 
              if (alpha > 128) {
                r += pixels[i];
                g += pixels[i + 1];
                b += pixels[i + 2];
                count++;
              }
            }

            if (count === 0) {
              resolve('#3b82f6'); // é»˜è®¤è“è‰²
              return;
            }

            r = Math.round(r / count);
            g = Math.round(g / count);
            b = Math.round(b / count);

            // è½¬æ¢ä¸ºåå…­è¿›åˆ¶
            const hex = `#${((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1)}`;

            resolve(hex);
          } catch (error) {
            reject(error);
          }
        };

        img.onerror = function() {
          reject(new Error('å›¾æ ‡åŠ è½½å¤±è´¥'));
        };

        img.src = proxyImageUrl;
      });
    }

    // æ˜¾ç¤ºé¢„è§ˆ
    function showFetchPreview(iconUrl, themeColor) {
      const preview = document.getElementById('fetch-preview');
      const iconImg = document.getElementById('preview-icon-img');
      const colorBox = document.getElementById('preview-color');
      const colorText = document.getElementById('preview-theme-color');

      // è®¾ç½®å›¾æ ‡
      if (iconUrl) {
        iconImg.src = iconUrl;
        iconImg.style.display = 'block';
      } else {
        iconImg.style.display = 'none';
      }

      // è®¾ç½®ä¸»é¢˜è‰²
      colorBox.style.backgroundColor = themeColor;
      colorText.textContent = `ä¸»é¢˜è‰²: ${themeColor}`;

      // æ˜¾ç¤ºé¢„è§ˆ
      preview.style.display = 'flex';
    }

    // è‡ªåŠ¨è·å–ç½‘ç«™ä¿¡æ¯
    async function autoFetch() {
      // è·å–è¾“å…¥çš„ URL
      const urlInput = document.getElementById('url');
      const url = urlInput.value.trim();

      // éªŒè¯ URL
      if (!url) {
        showMessage('è¯·å…ˆè¾“å…¥ç½‘å€', 'error');
        return;
      }

      if (!isValidUrl(url)) {
        showMessage('è¯·è¾“å…¥æœ‰æ•ˆçš„ç½‘å€', 'error');
        return;
      }

      // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
      const btn = document.getElementById('auto-fetch-btn');
      const originalText = btn.textContent;
      btn.disabled = true;
      btn.classList.add('loading');
      btn.textContent = 'è·å–ä¸­...';

      // éšè—é¢„è§ˆ
      document.getElementById('fetch-preview').style.display = 'none';

      try {
        // è§„èŒƒåŒ– URL
        const fullUrl = url.startsWith('http') ? url : 'https://' + url;

        // æ­¥éª¤1: æŠ“å–é¡µé¢å†…å®¹
        const html = await fetchPageContent(fullUrl);

        // æ­¥éª¤2: è§£æé¡µé¢ä¿¡æ¯
        const pageInfo = extractPageInfo(html, fullUrl);

        if (!pageInfo.title) {
          throw new Error('æœªæ‰¾åˆ°é¡µé¢æ ‡é¢˜');
        }

        // æ­¥éª¤3: å¡«å……è¡¨å• - æ ‡é¢˜
        document.getElementById('name').value = pageInfo.title;

        // æ­¥éª¤4: ä¿å­˜å›¾æ ‡ URL
        fetchedIconUrl = pageInfo.iconUrl;

        // æ­¥éª¤5: æå–ä¸»é¢˜è‰²ï¼ˆå¼‚æ­¥ï¼Œä¸é˜»å¡ï¼‰
        let themeColor = '#3b82f6'; // é»˜è®¤é¢œè‰²
        try {
          if (pageInfo.iconUrl) {
            themeColor = await extractThemeColor(pageInfo.iconUrl);
          }
        } catch (colorError) {
          console.warn('ä¸»é¢˜è‰²æå–å¤±è´¥:', colorError);
          // ä½¿ç”¨é»˜è®¤é¢œè‰²
        }

        fetchedThemeColor = themeColor;

        // æ­¥éª¤6: æ˜¾ç¤ºé¢„è§ˆ
        showFetchPreview(pageInfo.iconUrl, themeColor);

        // æˆåŠŸæç¤º
        showMessage('è‡ªåŠ¨è·å–æˆåŠŸï¼', 'success');

      } catch (error) {
        console.error('è‡ªåŠ¨è·å–å¤±è´¥:', error);
        showMessage('æ— æ³•è·å–ï¼Œè¯·æ£€æŸ¥ç½‘å€æˆ–æ‰‹åŠ¨å¡«å†™', 'error');

        // æ¸…ç©ºå¯èƒ½çš„éƒ¨åˆ†å¡«å……
        fetchedIconUrl = '';
        fetchedThemeColor = '';
      } finally {
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        btn.disabled = false;
        btn.classList.remove('loading');
        btn.textContent = originalText;
      }
    }

    // è¯»å–æ–‡ä»¶å†…å®¹
    async function readFileContent(fileHandle) {
      const file = await fileHandle.getFile();
      const content = await file.text();
      return content;
    }

    // å¯æ”¹å‚æ•°ï¼šè§£æé…ç½®æ•°ç»„ï¼ˆä½¿ç”¨æ‹¬å·åŒ¹é…ç®—æ³•ï¼‰
    function parseConfig(htmlContent) {
      try {
        console.log('ğŸ” å¼€å§‹è§£æé…ç½®ï¼Œæ–‡ä»¶å¤§å°:', htmlContent.length, 'å­—ç¬¦');
        
        // å°è¯•å¤šç§æ–¹å¼æŸ¥æ‰¾ SITE_CONFIG
        let match = null;
        let configRegex = null;
        
        // æ–¹æ³•1: æ ‡å‡†æ ¼å¼ï¼ˆå¸¦å¯é€‰ç©ºæ ¼ï¼‰
        configRegex = /const\s+SITE_CONFIG\s*=\s*\[/;
        match = htmlContent.match(configRegex);
        
        if (!match) {
          // æ–¹æ³•2: æ›´å®½æ¾çš„åŒ¹é…ï¼ˆå…è®¸ä»»æ„ç©ºç™½å­—ç¬¦ï¼‰
          console.log('âš ï¸ æ–¹æ³•1æœªæ‰¾åˆ°ï¼Œå°è¯•æ–¹æ³•2...');
          configRegex = /SITE_CONFIG\s*=\s*\[/;
          match = htmlContent.match(configRegex);
        }
        
        if (!match) {
          // æ–¹æ³•3: ç›´æ¥æŸ¥æ‰¾å…³é”®å­—å¹¶æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
          console.log('âš ï¸ æ–¹æ³•2æœªæ‰¾åˆ°ï¼Œå°è¯•æ–¹æ³•3...');
          const searchText = 'SITE_CONFIG';
          const index = htmlContent.indexOf(searchText);
          
          // æ˜¾ç¤ºæ–‡ä»¶å‰100ä¸ªå­—ç¬¦å¸®åŠ©ç”¨æˆ·è¯†åˆ«
          console.log('ğŸ“„ æ–‡ä»¶å¼€å¤´å†…å®¹:\n', htmlContent.substring(0, 200));
          
          if (index !== -1) {
            console.log('ğŸ“ æ‰¾åˆ° SITE_CONFIG å…³é”®å­—åœ¨ä½ç½®:', index);
            const snippet = htmlContent.substring(Math.max(0, index - 50), index + 100);
            console.log('ğŸ“„ å‘¨å›´ä»£ç :\n', snippet);
          } else {
            console.log('âŒ æ–‡ä»¶ä¸­å®Œå…¨æ‰¾ä¸åˆ° SITE_CONFIG å…³é”®å­—ï¼');
            console.log('ğŸ’¡ è¿™å¯èƒ½ä¸æ˜¯æ­£ç¡®çš„ index.html æ–‡ä»¶ã€‚');
          }
          
          throw new Error('æœªæ‰¾åˆ° SITE_CONFIG é…ç½®ã€‚è¯·ç¡®è®¤ï¼š\n1. é€‰æ‹©çš„æ˜¯é¡¹ç›®æ ¹ç›®å½•ä¸‹çš„ index.html\n2. æ–‡ä»¶å¤§å°åº”è¯¥çº¦ 16KBï¼ˆå½“å‰åªæœ‰ ' + Math.round(htmlContent.length / 1024) + 'KBï¼‰\n3. æ–‡ä»¶å¼€å¤´åº”è¯¥æ˜¯ "<!DOCTYPE html>"');
        }
        
        console.log('âœ… æ‰¾åˆ°é…ç½®å®šä¹‰ï¼Œä½ç½®:', match.index);
        
        // è·å–åŒ¹é…çš„èµ·å§‹ä½ç½®
        const startIndex = match.index;
        const matchedText = match[0];
        
        // ä»èµ·å§‹ä½ç½®å¼€å§‹è§£æï¼Œä½¿ç”¨æ‹¬å·åŒ¹é…ç®—æ³•
        const configStart = startIndex + matchedText.length;
        let bracketCount = 1; // å·²ç»åŒ¹é…åˆ°ç¬¬ä¸€ä¸ª [ï¼Œæ‰€ä»¥ä» 1 å¼€å§‹
        let endIndex = -1;
        
        // é€å­—ç¬¦æ‰«æï¼ŒåŒ¹é…æ–¹æ‹¬å·
        for (let i = configStart; i < htmlContent.length; i++) {
          const char = htmlContent[i];
          
          if (char === '[') {
            bracketCount++;
          } else if (char === ']') {
            bracketCount--;
            
            // å½“æ‹¬å·è®¡æ•°å½’é›¶æ—¶ï¼Œæ‰¾åˆ°äº†é…ç½®æ•°ç»„çš„ç»“æŸä½ç½®
            if (bracketCount === 0) {
              endIndex = i + 1;
              break;
            }
          }
        }
        
        if (endIndex === -1) {
          throw new Error('SITE_CONFIG æ ¼å¼ä¸å®Œæ•´ï¼Œç¼ºå°‘é—­åˆæ‹¬å·');
        }
        
        console.log('âœ… æ‰¾åˆ°é…ç½®ç»“æŸä½ç½®:', endIndex);
        
        // æå–é…ç½®å­—ç¬¦ä¸²ï¼ˆåŒ…æ‹¬å¼€å§‹çš„ [ å’Œç»“æŸçš„ ]ï¼‰
        const configString = htmlContent.substring(configStart - 1, endIndex);
        console.log('ğŸ“¦ é…ç½®å­—ç¬¦ä¸²é•¿åº¦:', configString.length);
        
        // è§£æé…ç½®ï¼ˆä½¿ç”¨ evalï¼Œå› ä¸ºå¯èƒ½åŒ…å« JavaScript è¡¨è¾¾å¼å’Œæ³¨é‡Šï¼‰
        const config = eval(`(${configString})`);
        
        // éªŒè¯é…ç½®ç±»å‹
        if (!Array.isArray(config)) {
          throw new Error('SITE_CONFIG å¿…é¡»æ˜¯æ•°ç»„æ ¼å¼');
        }
        
        console.log('âœ… æˆåŠŸè§£æé…ç½®ï¼Œæ‰¾åˆ°', config.length, 'ä¸ªå¡ç‰‡');
        return config;
      } catch (e) {
        console.error('âŒ è§£æé…ç½®å¤±è´¥:', e);
        throw new Error('è§£æé…ç½®å¤±è´¥ï¼Œè¯·æ£€æŸ¥ index.html æ–‡ä»¶æ ¼å¼ï¼š' + e.message);
      }
    }

    // æ›´æ–°é…ç½®åˆ° HTML å†…å®¹
    function updateConfig(htmlContent, newConfigArray) {
      try {
        // ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æŸ¥æ‰¾ SITE_CONFIGï¼ˆå…è®¸å‰é¢æœ‰ç©ºæ ¼ç¼©è¿›ï¼‰
        const configRegex = /const\s+SITE_CONFIG\s*=\s*\[/;
        const match = htmlContent.match(configRegex);
        
        if (!match) {
          throw new Error('æœªæ‰¾åˆ° SITE_CONFIG é…ç½®');
        }
        
        // è·å–åŒ¹é…çš„èµ·å§‹ä½ç½®
        const startIndex = match.index;
        const matchedText = match[0];
        
        // ä½¿ç”¨æ‹¬å·åŒ¹é…ç®—æ³•æ‰¾åˆ°ç»“æŸä½ç½®
        const configStart = startIndex + matchedText.length;
        let bracketCount = 1; // å·²ç»åŒ¹é…åˆ°ç¬¬ä¸€ä¸ª [
        let endIndex = -1;
        
        for (let i = configStart; i < htmlContent.length; i++) {
          const char = htmlContent[i];
          if (char === '[') {
            bracketCount++;
          } else if (char === ']') {
            bracketCount--;
            if (bracketCount === 0) {
              endIndex = i + 1;
              break;
            }
          }
        }
        
        if (endIndex === -1) {
          throw new Error('SITE_CONFIG æ ¼å¼ä¸å®Œæ•´');
        }
        
        // æ ¼å¼åŒ–æ–°é…ç½®ï¼ˆä½¿ç”¨ 6 ç©ºæ ¼ç¼©è¿›ä»¥åŒ¹é…åŸæ–‡ä»¶æ ¼å¼ï¼‰
        const configString = JSON.stringify(newConfigArray, null, 6);
        
        // æ„å»ºæ–°å†…å®¹ï¼šå‰éƒ¨åˆ† + æ–°é…ç½® + åéƒ¨åˆ†
        // æ³¨æ„ï¼šconfigStart - 1 æ˜¯å› ä¸ºè¦åŒ…å« [
        const before = htmlContent.substring(0, configStart - 1);
        const after = htmlContent.substring(endIndex);
        
        console.log('âœ… é…ç½®æ›´æ–°æˆåŠŸ');
        return before + configString + after;
      } catch (e) {
        console.error('æ›´æ–°é…ç½®å¤±è´¥:', e);
        throw new Error('æ›´æ–°é…ç½®å¤±è´¥ï¼š' + e.message);
      }
    }

    // å†™å…¥æ–‡ä»¶å†…å®¹
    async function writeFileContent(fileHandle, content) {
      try {
        const writable = await fileHandle.createWritable();
        await writable.write(content);
        await writable.close();
      } catch (e) {
        throw new Error('å†™å…¥æ–‡ä»¶å¤±è´¥ï¼š' + e.message);
      }
    }

    // é€‰æ‹©æ–‡ä»¶
    async function selectFile() {
      try {
        // æ‰“å¼€æ–‡ä»¶é€‰æ‹©å™¨
        const [handle] = await window.showOpenFilePicker({
          types: [{
            description: 'HTML Files',
            accept: { 'text/html': ['.html'] }
          }],
          multiple: false
        });

        fileHandle = handle;

        // è¯»å–æ–‡ä»¶å†…å®¹
        originalContent = await readFileContent(fileHandle);

        // è§£æé…ç½®
        configArray = parseConfig(originalContent);

        // æ›´æ–°ç•Œé¢çŠ¶æ€
        const fileName = fileHandle.name;
        const statusElement = document.getElementById('file-status');
        statusElement.textContent = `âœ… å·²é€‰æ‹©ï¼š${fileName}ï¼ˆ${configArray.length} ä¸ªå¡ç‰‡ï¼‰`;
        statusElement.classList.add('active');

        // æ¸²æŸ“å¡ç‰‡åˆ—è¡¨
        renderCardList();

        showMessage('æ–‡ä»¶åŠ è½½æˆåŠŸï¼', 'success');
      } catch (error) {
        if (error.name !== 'AbortError') {
          console.error('é€‰æ‹©æ–‡ä»¶å¤±è´¥:', error);
          showMessage('æ–‡ä»¶åŠ è½½å¤±è´¥ï¼š' + error.message, 'error');
        }
      }
    }

    // æ¸²æŸ“å¡ç‰‡åˆ—è¡¨
    function renderCardList() {
      const container = document.getElementById('cards');
      container.innerHTML = '';

      if (configArray.length === 0) {
        container.innerHTML = '<li class="empty">æš‚æ— å¡ç‰‡ï¼Œç‚¹å‡»ä¸Šæ–¹æ·»åŠ ç¬¬ä¸€ä¸ªå§ï¼</li>';
        return;
      }

      configArray.forEach(card => {
        const li = document.createElement('li');
        li.className = 'card-item';
        li.innerHTML = `
          <div class="card-info">
            <strong>${card.name}</strong>
            <span class="url">${card.url}</span>
            <span class="desc">${card.description}</span>
          </div>
          <button class="btn-danger" onclick="deleteCard('${card.id}')" title="åˆ é™¤">Ã—</button>
        `;
        container.appendChild(li);
      });
    }

    // ä¿å­˜é…ç½®åˆ°æ–‡ä»¶
    async function saveConfig() {
      try {
        // è¯»å–å½“å‰æ–‡ä»¶å†…å®¹ï¼ˆå¯èƒ½è¢«å¤–éƒ¨ä¿®æ”¹ï¼‰
        const currentContent = await readFileContent(fileHandle);

        // æ›´æ–°é…ç½®
        const newContent = updateConfig(currentContent, configArray);

        // å†™å›æ–‡ä»¶
        await writeFileContent(fileHandle, newContent);

        return true;
      } catch (error) {
        console.error('ä¿å­˜å¤±è´¥:', error);
        showMessage('ä¿å­˜å¤±è´¥ï¼š' + error.message, 'error');
        return false;
      }
    }

    // æ·»åŠ å¡ç‰‡
    async function addCard() {
      // éªŒè¯ fileHandle æ˜¯å¦å·²é€‰æ‹©
      if (!fileHandle) {
        showMessage('è¯·å…ˆé€‰æ‹© index.html æ–‡ä»¶', 'error');
        return;
      }

      // è·å–è¡¨å•è¾“å…¥å€¼
      const name = document.getElementById('name').value.trim();
      const url = document.getElementById('url').value.trim();
      const description = document.getElementById('description').value.trim();

      // éªŒè¯å¿…å¡«å­—æ®µ
      if (!name || !url) {
        showMessage('åç§°å’Œç½‘å€ä¸èƒ½ä¸ºç©º', 'error');
        return;
      }

      // éªŒè¯ URL æ ¼å¼
      if (!isValidUrl(url)) {
        showMessage('è¯·è¾“å…¥æœ‰æ•ˆçš„ç½‘å€', 'error');
        return;
      }

      // åˆ›å»ºæ–°å¡ç‰‡å¯¹è±¡
      const fullUrl = url.startsWith('http') ? url : 'https://' + url;
      
      // ä¼˜å…ˆä½¿ç”¨è‡ªåŠ¨è·å–çš„å›¾æ ‡ï¼Œå¦åˆ™ä½¿ç”¨é»˜è®¤æ–¹æ¡ˆ
      let iconUrl = fetchedIconUrl;
      if (!iconUrl) {
        const domain = extractDomain(fullUrl);
        iconUrl = `${domain}/favicon.ico`;
      }
      
      const newCard = {
        id: generateId(),
        name: name,
        url: fullUrl,
        icon: iconUrl,
        description: description || 'æš‚æ— æè¿°'
      };

      // æ·»åŠ åˆ°é…ç½®æ•°ç»„
      configArray.push(newCard);

      // ä¿å­˜æ–‡ä»¶
      const success = await saveConfig();
      
      if (success) {
        // æ¸…ç©ºè¡¨å•
        document.getElementById('name').value = '';
        document.getElementById('url').value = '';
        document.getElementById('description').value = '';

        // æ¸…ç©ºè‡ªåŠ¨è·å–çš„æ•°æ®
        fetchedIconUrl = '';
        fetchedThemeColor = '';
        document.getElementById('fetch-preview').style.display = 'none';

        // åˆ·æ–°åˆ—è¡¨
        renderCardList();

        // æ›´æ–°çŠ¶æ€
        const statusElement = document.getElementById('file-status');
        statusElement.textContent = `âœ… å·²é€‰æ‹©ï¼š${fileHandle.name}ï¼ˆ${configArray.length} ä¸ªå¡ç‰‡ï¼‰`;

        // æˆåŠŸæç¤º
        showMessage('æ·»åŠ æˆåŠŸï¼', 'success');
      }
    }

    // åˆ é™¤å¡ç‰‡
    async function deleteCard(id) {
      // ç¡®è®¤åˆ é™¤
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¡ç‰‡å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')) {
        return;
      }

      // ä»é…ç½®æ•°ç»„ä¸­ç§»é™¤
      configArray = configArray.filter(card => card.id !== id);

      // ä¿å­˜æ–‡ä»¶
      const success = await saveConfig();
      
      if (success) {
        // åˆ·æ–°åˆ—è¡¨
        renderCardList();

        // æ›´æ–°çŠ¶æ€
        const statusElement = document.getElementById('file-status');
        statusElement.textContent = `âœ… å·²é€‰æ‹©ï¼š${fileHandle.name}ï¼ˆ${configArray.length} ä¸ªå¡ç‰‡ï¼‰`;

        // æˆåŠŸæç¤º
        showMessage('åˆ é™¤æˆåŠŸï¼', 'success');
      }
    }

    // æ˜¾ç¤ºæ¶ˆæ¯æç¤º
    function showMessage(text, type = 'info') {
      // åˆ›å»ºä¸´æ—¶æç¤ºå…ƒç´ 
      const msg = document.createElement('div');
      msg.className = `message ${type}`;
      msg.textContent = text;
      document.body.appendChild(msg);

      // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
      setTimeout(() => {
        msg.style.opacity = '0';
        setTimeout(() => msg.remove(), 300);
      }, 3000);
    }

    // åˆå§‹åŒ–
    function init() {
      // æ£€æŸ¥æµè§ˆå™¨æ”¯æŒ
      checkBrowserSupport();

      // ç»‘å®šäº‹ä»¶
      document.getElementById('select-file').addEventListener('click', selectFile);
      document.getElementById('add-btn').addEventListener('click', addCard);
      document.getElementById('auto-fetch-btn').addEventListener('click', autoFetch);

      // ç½‘å€è¾“å…¥æ¡†å˜åŒ–æ—¶æ¸…ç©ºé¢„è§ˆ
      document.getElementById('url').addEventListener('input', () => {
        fetchedIconUrl = '';
        fetchedThemeColor = '';
        document.getElementById('fetch-preview').style.display = 'none';
      });

      // è¡¨å•å›è½¦æäº¤
      const inputs = ['name', 'url', 'description'];
      inputs.forEach(id => {
        document.getElementById(id).addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            addCard();
          }
        });
      });
    }

    // DOM åŠ è½½å®Œæˆååˆå§‹åŒ–
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  </script>
</body>
</html>

